<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Agile Toolkit: /Users/rw/Sites/atk4web/atk4/lib/ApiWeb.php Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Agile Toolkit
   &#160;<span id="projectnumber">4.2</span>
   </div>
   <div id="projectbrief">Agile Toolkit is a powerful web development framework. Inspired by GUI Applications development</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_api_web_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/Users/rw/Sites/atk4web/atk4/lib/ApiWeb.php</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php <span class="comment">// vim:ts=4:sw=4:et:fdm=marker/*</span>
<a name="l00009"></a>00009 ==ATK4===================================================
<a name="l00010"></a>00010    This file is part of Agile Toolkit 4 
<a name="l00011"></a>00011     http:<span class="comment">//agiletoolkit.org/</span>
<a name="l00012"></a>00012   
<a name="l00013"></a>00013    (c) 2008-2012 Romans Malinovskis &lt;romans@agiletoolkit.org&gt;
<a name="l00014"></a>00014    Distributed under Affero General Public License v3
<a name="l00015"></a>00015    
<a name="l00016"></a>00016    See http:<span class="comment">//agiletoolkit.org/about/license</span>
<a name="l00017"></a>00017  =====================================================ATK4=*/
<a name="l00018"></a><a class="code" href="class_api_web.html">00018</a> <span class="keyword">class</span> <a class="code" href="class_api_web.html">ApiWeb</a> extends <a class="code" href="class_api_c_l_i.html">ApiCLI</a> {
<a name="l00019"></a>00019 
<a name="l00021"></a><a class="code" href="class_api_web.html#a0a44e6760141442bb439b1ab1395d8ff">00021</a>     <span class="keyword">public</span> $page=null;
<a name="l00022"></a>00022 
<a name="l00023"></a>00023     <span class="comment">/* Root page where URL will send when (&#39;/&#39;) is encountered @todo: make this work properly */</span>
<a name="l00024"></a>00024     <span class="keyword">public</span> $index_page=<span class="stringliteral">&#39;index&#39;</span>;
<a name="l00025"></a>00025     
<a name="l00027"></a><a class="code" href="class_api_web.html#a73a034a7a0fbdd2c93f23fb6c9946ee9">00027</a>     <span class="keyword">public</span> $start_time=null;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029     <span class="keyword">private</span> $_license_checksum=null;
<a name="l00030"></a>00030     <span class="keyword">private</span> $_license=<span class="stringliteral">&#39;unlicensed&#39;</span>; 
<a name="l00031"></a>00031 
<a name="l00032"></a>00032     <span class="comment">// {{{ Start-up </span>
<a name="l00033"></a>00033     <span class="keyword">function</span> __construct($realm=null,$skin=<span class="stringliteral">&#39;default&#39;</span>){
<a name="l00034"></a>00034         $this-&gt;start_time=time()+microtime();
<a name="l00035"></a>00035 
<a name="l00036"></a>00036         $this-&gt;skin=$skin;
<a name="l00037"></a>00037         <span class="keywordflow">try</span> {
<a name="l00038"></a>00038             parent::__construct($realm);
<a name="l00039"></a>00039         }<span class="keywordflow">catch</span> (Exception $e){
<a name="l00040"></a>00040 
<a name="l00041"></a>00041             <span class="comment">// This exception is used to abort initialisation of the objects but when</span>
<a name="l00042"></a>00042             <span class="comment">// normal rendering is still required</span>
<a name="l00043"></a>00043             <span class="keywordflow">if</span>($e instanceof <a class="code" href="class_exception___stop_init.html">Exception_StopInit</a>)<span class="keywordflow">return</span>;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045             $this-&gt;caughtException($e);
<a name="l00046"></a>00046         }
<a name="l00047"></a>00047     }
<a name="l00049"></a><a class="code" href="class_api_web.html#a4be4055f3361d4800e16bc2e2e38cda6">00049</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a4be4055f3361d4800e16bc2e2e38cda6">init</a>(){
<a name="l00050"></a>00050         <span class="comment">// Do not initialize unless requsetd</span>
<a name="l00051"></a>00051         <span class="comment">//$this-&gt;initializeSession();</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         <span class="comment">// find out which page is to display</span>
<a name="l00054"></a>00054         <span class="comment">//$this-&gt;calculatePageName();</span>
<a name="l00055"></a>00055         $this-&gt;pm=$this-&gt;add(<span class="stringliteral">&#39;PageManager&#39;</span>);
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <span class="comment">// Verify Licensing</span>
<a name="l00058"></a>00058         $this-&gt;licenseCheck(<span class="stringliteral">&#39;atk4&#39;</span>);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060         <span class="comment">// send headers, no caching</span>
<a name="l00061"></a>00061         $this-&gt;sendHeaders();
<a name="l00062"></a>00062 
<a name="l00063"></a>00063         $this-&gt;cleanMagicQuotes();
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         parent::init();
<a name="l00066"></a>00066 
<a name="l00068"></a>00068         $this-&gt;getLogger();
<a name="l00069"></a>00069         $this-&gt;initializeTemplate();
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordflow">if</span>(get_class($this)==<span class="stringliteral">&#39;ApiWeb&#39;</span>){
<a name="l00073"></a>00073             $this-&gt;setConfig(array(<span class="stringliteral">&#39;url_postfix&#39;</span>=&gt;<span class="stringliteral">&#39;.php&#39;</span>,<span class="stringliteral">&#39;url_prefix&#39;</span>=&gt;<span class="stringliteral">&#39;&#39;</span>));
<a name="l00074"></a>00074         }
<a name="l00075"></a>00075     }
<a name="l00077"></a><a class="code" href="class_api_web.html#a77ffb6f1dc198bf8cbd0d81667e1249d">00077</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a77ffb6f1dc198bf8cbd0d81667e1249d">cleanMagicQuotes</a>(){
<a name="l00078"></a>00078         <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&quot;stripslashes_array&quot;</span>)){
<a name="l00079"></a>00079             <span class="keyword">function</span> stripslashes_array(&amp;$array, $iterations=0) {
<a name="l00080"></a>00080                 <span class="keywordflow">if</span> ($iterations &lt; 3){
<a name="l00081"></a>00081                     <span class="keywordflow">foreach</span> ($array as $key =&gt; $value){
<a name="l00082"></a>00082                         <span class="keywordflow">if</span> (is_array($value)){
<a name="l00083"></a>00083                             stripslashes_array($array[$key], $iterations + 1);
<a name="l00084"></a>00084                         } <span class="keywordflow">else</span> {
<a name="l00085"></a>00085                             $array[$key] = stripslashes($array[$key]);
<a name="l00086"></a>00086                         }
<a name="l00087"></a>00087                     }
<a name="l00088"></a>00088                 }
<a name="l00089"></a>00089             }
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (get_magic_quotes_gpc()){
<a name="l00093"></a>00093             stripslashes_array($_GET);
<a name="l00094"></a>00094             stripslashes_array($_POST);
<a name="l00095"></a>00095             stripslashes_array($_COOKIE);
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097     }
<a name="l00099"></a><a class="code" href="class_api_web.html#abab55ed2b1496fd1d0f631fc99d71ed4">00099</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#abab55ed2b1496fd1d0f631fc99d71ed4">sendHeaders</a>(){
<a name="l00100"></a>00100         header(<span class="stringliteral">&quot;Content-Type: text/html; charset=utf-8&quot;</span>);
<a name="l00101"></a>00101         header(<span class="stringliteral">&quot;Expires: Mon, 26 Jul 1997 05:00:00 GMT&quot;</span>);               <span class="comment">// Date in the past</span>
<a name="l00102"></a>00102         header(<span class="stringliteral">&quot;Last-Modified: &quot;</span> . gmdate(<span class="stringliteral">&quot;D, d M Y H:i:s&quot;</span>) . <span class="stringliteral">&quot; GMT&quot;</span>);  <span class="comment">// always modified</span>
<a name="l00103"></a>00103         header(<span class="stringliteral">&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;</span>);   <span class="comment">// HTTP/1.1</span>
<a name="l00104"></a>00104         header(<span class="stringliteral">&quot;Cache-Control: post-check=0, pre-check=0&quot;</span>, <span class="keyword">false</span>);
<a name="l00105"></a>00105         header(<span class="stringliteral">&quot;Pragma: no-cache&quot;</span>);                                     <span class="comment">// HTTP/1.0</span>
<a name="l00106"></a>00106     }
<a name="l00108"></a><a class="code" href="class_api_web.html#ae5683284d126e7da841b1e563a37bda1">00108</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#ae5683284d126e7da841b1e563a37bda1">showExecutionTime</a>(){
<a name="l00109"></a>00109         $self=$this;
<a name="l00110"></a>00110         $this-&gt;addHook(<span class="stringliteral">&#39;post-render-output&#39;</span>,array($this,<span class="stringliteral">&#39;_showExecutionTime&#39;</span>));
<a name="l00111"></a>00111         $this-&gt;addHook(<span class="stringliteral">&#39;post-js-execute&#39;</span>,array($this,<span class="stringliteral">&#39;_showExecutionTimeJS&#39;</span>));
<a name="l00112"></a>00112     }
<a name="l00114"></a><a class="code" href="class_api_web.html#a68c10124302012b9a0c5eaeba614a8e5">00114</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a68c10124302012b9a0c5eaeba614a8e5">_showExecutionTime</a>(){
<a name="l00115"></a>00115         echo <span class="stringliteral">&#39;Took &#39;</span>.(time()+microtime()-$this-&gt;start_time).<span class="charliteral">&#39;s&#39;</span>;
<a name="l00116"></a>00116     }
<a name="l00118"></a><a class="code" href="class_api_web.html#a6109d8503dafbb69be848c0c3b395d88">00118</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a6109d8503dafbb69be848c0c3b395d88">_showExecutionTimeJS</a>(){
<a name="l00119"></a>00119         echo <span class="stringliteral">&quot;\n\n/* Took &quot;</span>.number_format(time()+microtime()-$this-&gt;start_time,5).<span class="stringliteral">&#39;s */&#39;</span>;
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     <span class="comment">// }}}</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="comment">// {{{ License checking function</span>
<a name="l00125"></a><a class="code" href="class_api_web.html#a918ebf81ed5c431a5c7349588d42b56f">00125</a> <span class="comment"></span>    <span class="keyword">final</span> <span class="keyword">function</span> <a class="code" href="class_api_web.html#a918ebf81ed5c431a5c7349588d42b56f">license</a>(){
<a name="l00126"></a>00126         <span class="keywordflow">return</span> $this-&gt;_license;
<a name="l00127"></a>00127     }
<a name="l00130"></a><a class="code" href="class_api_web.html#a828ebd72e63e2dff342f03c183ef52a8">00130</a>     <span class="keyword">final</span> <span class="keyword">function</span> <a class="code" href="class_api_web.html#a828ebd72e63e2dff342f03c183ef52a8">license_checksum</a>(){
<a name="l00131"></a>00131         <span class="keywordflow">return</span> $this-&gt;_license_checksum;
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133     <span class="keyword">final</span> <span class="keyword">function</span> licenseCheck($product){
<a name="l00134"></a>00134         <span class="comment">/* An average Agile Toolkit developer can earn cost of Agile Toolkit in less than</span>
<a name="l00135"></a>00135 <span class="comment">            3 work hours. Your honest purchase is really necessary to keep Agile Toolkit</span>
<a name="l00136"></a>00136 <span class="comment">            development alive. Please do not tamper with licensing mechanisms. Thank you!</span>
<a name="l00137"></a>00137 <span class="comment">            */</span>
<a name="l00138"></a>00138         $id=$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;license/&#39;</span>.$product.<span class="stringliteral">&#39;/id&#39;</span>,<span class="keyword">false</span>);
<a name="l00139"></a>00139         <span class="keywordflow">if</span>(!$id)<span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         $type=$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;license/&#39;</span>.$product.<span class="stringliteral">&#39;/type&#39;</span>,<span class="keyword">false</span>);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         $data=$_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>].<span class="charliteral">&#39;|&#39;</span>.$id.<span class="charliteral">&#39;|&#39;</span>.$type;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;agpl&#39;</span>){
<a name="l00146"></a>00146             $data.=<span class="charliteral">&#39;|&#39;</span>.$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;license/&#39;</span>.$product.<span class="stringliteral">&#39;/repo&#39;</span>,<span class="keyword">false</span>);
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         $this-&gt;api-&gt;_license_checksum=md5($data);
<a name="l00150"></a>00150         <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&#39;openssl_get_publickey&#39;</span>))<span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         $cert=$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;license/&#39;</span>.$product.<span class="stringliteral">&#39;/public&#39;</span>,
<a name="l00153"></a>00153             dirname(dirname(__FILE__)).DIRECTORY_SEPARATOR.<span class="stringliteral">&#39;cert&#39;</span>.
<a name="l00154"></a>00154             DIRECTORY_SEPARATOR.<span class="stringliteral">&#39;atk4.crt&#39;</span>);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         $signature=$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;license/&#39;</span>.$product.<span class="stringliteral">&#39;/certificate&#39;</span>,<span class="keyword">false</span>);
<a name="l00157"></a>00157         <span class="keywordflow">if</span>(!$signature)<span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         $cert=openssl_get_publickey(file_get_contents($cert));
<a name="l00160"></a>00160         <span class="keywordflow">if</span>(!$cert)<span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         $result = openssl_verify($data,base64_decode($signature),$cert);
<a name="l00163"></a>00163         openssl_free_key($cert);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">if</span>($result==1 &amp;&amp; $product==<span class="stringliteral">&#39;atk4&#39;</span>){
<a name="l00166"></a>00166             $this-&gt;_license=$type;
<a name="l00167"></a>00167             <span class="keywordflow">return</span> <span class="keyword">true</span>;   <span class="comment">// certificate matched</span>
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00171"></a>00171     }
<a name="l00175"></a><a class="code" href="class_api_web.html#a549d9c59de071367179a82be7918c2b2">00175</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a549d9c59de071367179a82be7918c2b2">upgradeChecker</a>(){
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         <span class="keywordflow">try</span>{
<a name="l00178"></a>00178             <span class="keywordflow">if</span>($this-&gt;<span class="keyword">template</span> &amp;&amp; $this-&gt;template-&gt;is_set(<span class="stringliteral">&#39;version&#39;</span>)){
<a name="l00179"></a>00179                 $this-&gt;add(<span class="stringliteral">&#39;licensor/UpgradeChecker&#39;</span>,null,<span class="stringliteral">&#39;version&#39;</span>);
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181         }<span class="keywordflow">catch</span>(<a class="code" href="class_path_finder___exception.html">PathFinder_Exception</a> $e){}
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     <span class="comment">// }}}</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">// {{{ Obsolete</span>
<a name="l00188"></a><a class="code" href="class_api_web.html#ad6fbac308cf2c1d219e4c1d6d36ee4e0">00188</a> <span class="comment"></span>    <span class="keyword">function</span> <a class="code" href="class_api_web.html#ad6fbac308cf2c1d219e4c1d6d36ee4e0">caughtException</a>($e){
<a name="l00189"></a>00189         $this-&gt;hook(<span class="stringliteral">&#39;caught-exception&#39;</span>,array($e));
<a name="l00190"></a>00190         echo <span class="stringliteral">&quot;&lt;font color=red&gt;&quot;</span>,$e,<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>;
<a name="l00191"></a>00191         echo <span class="stringliteral">&quot;&lt;p&gt;Please use &#39;Logger&#39; class for more sophisticated output&lt;br&gt;\$api-&amp;gt;add(&#39;Logger&#39;);&lt;/p&gt;&quot;</span>;
<a name="l00192"></a>00192         exit;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00196"></a><a class="code" href="class_api_web.html#a15b908f9b57ba6d5eb3d9e0214f3f2d1">00196</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a15b908f9b57ba6d5eb3d9e0214f3f2d1">outputWarning</a>($msg,$shift=0){
<a name="l00197"></a>00197         <span class="keywordflow">if</span>($this-&gt;hook(<span class="stringliteral">&#39;output-warning&#39;</span>,array($msg,$shift)))<span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00198"></a>00198         echo <span class="stringliteral">&quot;&lt;font color=red&gt;&quot;</span>,$msg,<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>;
<a name="l00199"></a>00199     }
<a name="l00201"></a><a class="code" href="class_api_web.html#a41a61ce77bee992bb93b41015d617c81">00201</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a41a61ce77bee992bb93b41015d617c81">outputDebug</a>($msg,$shift=0){
<a name="l00202"></a>00202         <span class="keywordflow">if</span>($this-&gt;hook(<span class="stringliteral">&#39;output-debug&#39;</span>,array($msg,$shift)))<span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00203"></a>00203         echo <span class="stringliteral">&quot;&lt;font color=red&gt;&quot;</span>,$msg,<span class="stringliteral">&quot;&lt;/font&gt;&lt;br&gt;&quot;</span>;
<a name="l00204"></a>00204     }
<a name="l00206"></a><a class="code" href="class_api_web.html#aa7312b50ddc17745e01a698ef26ba724">00206</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#aa7312b50ddc17745e01a698ef26ba724">outputInfo</a>($msg,$shift=0){
<a name="l00207"></a>00207         <span class="keywordflow">if</span>($this-&gt;hook(<span class="stringliteral">&#39;output-info&#39;</span>,array($msg,$shift)))<span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00208"></a>00208         echo <span class="stringliteral">&quot;&lt;font color=red&gt;&quot;</span>,$msg,<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <span class="comment">// }}}</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// {{{ Session Initialization</span>
<a name="l00214"></a><a class="code" href="class_api_web.html#a05d7fd9138206b3a29fda8723e9b3a4d">00214</a> <span class="comment"></span>    <span class="keyword">public</span> $_is_session_initialized=<span class="keyword">false</span>;
<a name="l00215"></a>00215     <span class="keyword">function</span> initializeSession($create=<span class="keyword">true</span>){
<a name="l00216"></a>00216         <span class="comment">/* Attempts to re-initialize session. If session is not found,</span>
<a name="l00217"></a>00217 <span class="comment">           new one will be created, unless $create is set to false. Avoiding</span>
<a name="l00218"></a>00218 <span class="comment">           session creation and placing cookies is to enhance user privacy. </span>
<a name="l00219"></a>00219 <span class="comment">        Call to memorize() / recall() will automatically create session */</span>
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keywordflow">if</span>($this-&gt;_is_session_initialized)<span class="keywordflow">return</span>;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <span class="keywordflow">if</span>(isset($_GET[<span class="stringliteral">&#39;SESSION_ID&#39;</span>]))session_id($_GET[<span class="stringliteral">&#39;SESSION_ID&#39;</span>]);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="comment">// Change settings if defined in settings file</span>
<a name="l00227"></a>00227         $params=session_get_cookie_params();
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         $params[<span class="stringliteral">&#39;httponly&#39;</span>]=<span class="keyword">true</span>;   <span class="comment">// true by default</span>
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">foreach</span>($params as $key=&gt;$default){
<a name="l00232"></a>00232             $params[$key]=$this-&gt;api-&gt;getConfig(<span class="stringliteral">&#39;session/&#39;</span>.$key,$default);
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="keywordflow">if</span>($create==<span class="keyword">false</span> &amp;&amp; !isset($_COOKIE[$this-&gt;name]))<span class="keywordflow">return</span>;
<a name="l00236"></a>00236         $this-&gt;_is_session_initialized=<span class="keyword">true</span>;
<a name="l00237"></a>00237         session_set_cookie_params(
<a name="l00238"></a>00238             $params[<span class="stringliteral">&#39;lifetime&#39;</span>],
<a name="l00239"></a>00239             $params[<span class="stringliteral">&#39;path&#39;</span>],
<a name="l00240"></a>00240             $params[<span class="stringliteral">&#39;domain&#39;</span>],
<a name="l00241"></a>00241             $params[<span class="stringliteral">&#39;secure&#39;</span>],
<a name="l00242"></a>00242             $params[<span class="stringliteral">&#39;httponly&#39;</span>]
<a name="l00243"></a>00243         );
<a name="l00244"></a>00244         session_name($this-&gt;name);
<a name="l00245"></a>00245         session_start();
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247     <span class="comment">// }}}</span>
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">// {{{ Sticky GET Argument implementation. Register stickyGET to have it appended to all generated URLs</span>
<a name="l00250"></a>00250     <span class="keyword">public</span> $sticky_get_arguments = array();
<a name="l00252"></a><a class="code" href="class_api_web.html#ac7d3e7afa13d05e9ae5c6c7e2aabd225">00252</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#ac7d3e7afa13d05e9ae5c6c7e2aabd225">stickyGET</a>($name){
<a name="l00253"></a>00253         $this-&gt;sticky_get_arguments[$name]=@$_GET[$name];
<a name="l00254"></a>00254     }
<a name="l00256"></a><a class="code" href="class_api_web.html#a8d3febf4b27bf7960c3ff09b436eacad">00256</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a8d3febf4b27bf7960c3ff09b436eacad">stickyForget</a>($name){
<a name="l00257"></a>00257         unset($this-&gt;sticky_get_arguments[$name]);
<a name="l00258"></a>00258     }
<a name="l00260"></a><a class="code" href="class_api_web.html#a1a5b9b7bc783823accde6b0b9ce16f86">00260</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a1a5b9b7bc783823accde6b0b9ce16f86">getStickyArguments</a>(){
<a name="l00261"></a>00261         <span class="keywordflow">return</span> $this-&gt;sticky_get_arguments;
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="comment">// }}}</span>
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// {{{ Very Important Methods</span>
<a name="l00268"></a><a class="code" href="class_api_web.html#a51af30a60f9f02777c6396b8247e356f">00268</a> <span class="comment"></span>    <span class="keyword">function</span> <a class="code" href="class_api_web.html#a51af30a60f9f02777c6396b8247e356f">main</a>(){
<a name="l00269"></a>00269         <span class="keywordflow">try</span>{
<a name="l00270"></a>00270             <span class="comment">// Initialize page and all elements from here</span>
<a name="l00271"></a>00271             $this-&gt;initLayout();
<a name="l00272"></a>00272         }<span class="keywordflow">catch</span>(Exception $e){
<a name="l00273"></a>00273             <span class="keywordflow">if</span>(!($e instanceof <a class="code" href="class_exception___stop_init.html">Exception_StopInit</a>))
<a name="l00274"></a>00274                 <span class="keywordflow">return</span> $this-&gt;caughtException($e);
<a name="l00275"></a>00275             <span class="comment">//$this-&gt;caughtException($e);</span>
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">try</span>{
<a name="l00279"></a>00279             $this-&gt;hook(<span class="stringliteral">&#39;post-init&#39;</span>);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281             $this-&gt;hook(<span class="stringliteral">&#39;pre-exec&#39;</span>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283             <span class="keywordflow">if</span>(isset($_GET[<span class="stringliteral">&#39;submit&#39;</span>]) &amp;&amp; $_POST){
<a name="l00284"></a>00284                 $this-&gt;hook(<span class="stringliteral">&#39;submitted&#39;</span>);
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287             $this-&gt;hook(<span class="stringliteral">&#39;post-submit&#39;</span>);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289             $this-&gt;execute();
<a name="l00290"></a>00290         }<span class="keywordflow">catch</span>(Exception $e){
<a name="l00291"></a>00291             $this-&gt;caughtException($e);
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293     }
<a name="l00295"></a><a class="code" href="class_api_web.html#a1909f4b7f8129c7790cb75de2ffbe1e4">00295</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a1909f4b7f8129c7790cb75de2ffbe1e4">execute</a>(){
<a name="l00296"></a>00296         $this-&gt;rendered[<span class="stringliteral">&#39;sub-elements&#39;</span>]=array();
<a name="l00297"></a>00297         <span class="keywordflow">try</span> {
<a name="l00298"></a>00298             $this-&gt;hook(<span class="stringliteral">&#39;pre-render&#39;</span>);
<a name="l00299"></a>00299             $this-&gt;recursiveRender();
<a name="l00300"></a>00300             <span class="keywordflow">if</span>(isset($_GET[<span class="stringliteral">&#39;cut_object&#39;</span>]))
<a name="l00301"></a>00301                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_base_exception.html">BaseException</a>(<span class="stringliteral">&quot;Unable to cut object with name=&#39;&quot;</span>.$_GET[<span class="stringliteral">&#39;cut_object&#39;</span>].<span class="stringliteral">&quot;&#39;. It wasn&#39;t initialized&quot;</span>);
<a name="l00302"></a>00302             <span class="keywordflow">if</span>(isset($_GET[<span class="stringliteral">&#39;cut_region&#39;</span>])){
<a name="l00303"></a>00303                 <span class="keywordflow">if</span>(!$this-&gt;cut_region_result)
<a name="l00304"></a>00304                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_base_exception.html">BaseException</a>(<span class="stringliteral">&quot;Unable to cut region with name=&#39;&quot;</span>.$_GET[<span class="stringliteral">&#39;cut_region&#39;</span>].<span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00305"></a>00305                 echo $this-&gt;cut_region_result;
<a name="l00306"></a>00306                 <span class="keywordflow">return</span>;
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308         }<span class="keywordflow">catch</span>(Exception $e){
<a name="l00309"></a>00309             <span class="keywordflow">if</span>($e instanceof <a class="code" href="class_exception___stop_render.html">Exception_StopRender</a>){
<a name="l00310"></a>00310                 $this-&gt;hook(<span class="stringliteral">&#39;cut-output&#39;</span>);
<a name="l00311"></a>00311                 echo $e-&gt;result;
<a name="l00312"></a>00312                 $this-&gt;hook(<span class="stringliteral">&#39;post-render-output&#39;</span>);
<a name="l00313"></a>00313                 <span class="keywordflow">return</span>;
<a name="l00314"></a>00314             }
<a name="l00315"></a>00315             <span class="keywordflow">throw</span> $e;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318     }
<a name="l00320"></a><a class="code" href="class_api_web.html#afde88292c44dc59faf017738dae6dffb">00320</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#afde88292c44dc59faf017738dae6dffb">render</a>(){
<a name="l00321"></a>00321         <span class="keywordflow">if</span>(isset($this-&gt;api-&gt;jquery) &amp;&amp; $this-&gt;api-&gt;jquery)$this-&gt;api-&gt;jquery-&gt;getJS($this);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="keywordflow">if</span>(!($this-&gt;<span class="keyword">template</span>)){
<a name="l00324"></a>00324             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_base_exception.html">BaseException</a>(<span class="stringliteral">&quot;You should specify template for API object&quot;</span>);
<a name="l00325"></a>00325         }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         $this-&gt;hook(<span class="stringliteral">&#39;pre-render-output&#39;</span>);
<a name="l00328"></a>00328         <span class="keywordflow">if</span>(headers_sent($file,$line)){
<a name="l00329"></a>00329             echo <span class="stringliteral">&quot;&lt;br/&gt;Direct output (echo or print) detected on $file:$line. &lt;a target=&#39;_blank&#39; &quot;</span>
<a name="l00330"></a>00330                 .<span class="stringliteral">&quot;href=&#39;http://agiletoolkit.org/error/direct_output&#39;&gt;Use \$this-&gt;add(&#39;Text&#39;) instead&lt;/a&gt;.&lt;br/&gt;&quot;</span>;
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332         echo $this-&gt;<span class="keyword">template</span>-&gt;render();
<a name="l00333"></a>00333         $this-&gt;hook(<span class="stringliteral">&#39;post-render-output&#39;</span>);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     <span class="comment">// }}}</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">// {{{ Miscelanious Functions</span>
<a name="l00339"></a><a class="code" href="class_api_web.html#a62eae5ca4fe4403928092ef8eb0e9d1d">00339</a> <span class="comment"></span>    <span class="keyword">function</span> <a class="code" href="class_api_web.html#a62eae5ca4fe4403928092ef8eb0e9d1d">redirect</a>($page=null,$args=array()){
<a name="l00344"></a>00344         $url=$this-&gt;url($page,$args);
<a name="l00345"></a>00345                 <span class="keywordflow">if</span>($this-&gt;api-&gt;isAjaxOutput())$this-&gt;api-&gt;js()-&gt;univ()-&gt;redirect($url)-&gt;execute();
<a name="l00346"></a>00346         header(<span class="stringliteral">&quot;Location: &quot;</span>.$url);
<a name="l00347"></a>00347         exit;
<a name="l00348"></a>00348     }
<a name="l00350"></a><a class="code" href="class_api_web.html#aa265a4f5509ac06e3c0bc7517e591663">00350</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#aa265a4f5509ac06e3c0bc7517e591663">setTags</a>($t){
<a name="l00351"></a>00351         <span class="comment">// absolute path to base location</span>
<a name="l00352"></a>00352         $t-&gt;trySet(<span class="stringliteral">&#39;atk_path&#39;</span>,$q=
<a name="l00353"></a>00353             $this-&gt;api-&gt;pathfinder-&gt;atk_location-&gt;getURL().<span class="charliteral">&#39;/&#39;</span>);
<a name="l00354"></a>00354         $t-&gt;trySet(<span class="stringliteral">&#39;base_path&#39;</span>,$q=$this-&gt;api-&gt;pm-&gt;base_path);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="comment">// We are using new capability of SMlite to process tags individually</span>
<a name="l00357"></a>00357         $t-&gt;eachTag(<span class="stringliteral">&#39;template&#39;</span>,array($this,<span class="stringliteral">&#39;_locateTemplate&#39;</span>));
<a name="l00358"></a>00358         $t-&gt;eachTag(<span class="stringliteral">&#39;page&#39;</span>,array($this,<span class="stringliteral">&#39;_locatePage&#39;</span>));
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         $this-&gt;hook(<span class="stringliteral">&#39;set-tags&#39;</span>,array($t));
<a name="l00361"></a>00361     }
<a name="l00363"></a><a class="code" href="class_api_web.html#a9759ffd43dac374e766b19cc3e97e38a">00363</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a9759ffd43dac374e766b19cc3e97e38a">isAjaxOutput</a>(){
<a name="l00364"></a>00364         <span class="comment">// TODO: rename into isJSOutput();</span>
<a name="l00365"></a>00365         <span class="keywordflow">return</span> isset($_POST[<span class="stringliteral">&#39;ajax_submit&#39;</span>]);
<a name="l00366"></a>00366     }
<a name="l00368"></a>00368     <span class="keyword">function</span> _locateTemplate($path){
<a name="l00369"></a>00369         <span class="keywordflow">return</span> $this-&gt;locateURL(<span class="stringliteral">&#39;template&#39;</span>,$path);
<a name="l00370"></a>00370     }
<a name="l00372"></a>00372     <span class="keyword">function</span> _locatePage($path){
<a name="l00373"></a>00373         <span class="keywordflow">return</span> $this-&gt;getDestinationURL($path);
<a name="l00374"></a>00374     }
<a name="l00376"></a><a class="code" href="class_api_web.html#a6b1f9e6d6be3aaff35eb9a25354b589f">00376</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a6b1f9e6d6be3aaff35eb9a25354b589f">renderOnly</a>($object){
<a name="l00377"></a>00377         $_GET[<span class="stringliteral">&#39;cut_object&#39;</span>]=$object-&gt;name;
<a name="l00378"></a>00378         <span class="keywordflow">return</span> $this;
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380     <span class="comment">// }}}</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="comment">// {{{ Layout implementation</span>
<a name="l00383"></a>00383     <span class="keyword">private</span> $layout_initialized=<span class="keyword">false</span>;
<a name="l00385"></a><a class="code" href="class_api_web.html#a7196ccc788edd95f5cca8c764a79c135">00385</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a7196ccc788edd95f5cca8c764a79c135">initLayout</a>(){
<a name="l00386"></a>00386         <span class="keywordflow">if</span>($this-&gt;layout_initialized)<span class="keywordflow">throw</span> $this-&gt;exception(<span class="stringliteral">&#39;Please do not call initLayout() directly from init()&#39;</span>,<span class="stringliteral">&#39;Obsolete&#39;</span>);
<a name="l00387"></a>00387         $this-&gt;layout_initialized=<span class="keyword">true</span>;
<a name="l00388"></a>00388     }
<a name="l00390"></a><a class="code" href="class_api_web.html#ad15ae833701872ee84f1c3b98c2fc9f4">00390</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#ad15ae833701872ee84f1c3b98c2fc9f4">addLayout</a>($name){
<a name="l00391"></a>00391         <span class="keywordflow">if</span>(!$this-&gt;<span class="keyword">template</span>)<span class="keywordflow">return</span>;
<a name="l00392"></a>00392         <span class="comment">// TODO: change to functionExists()</span>
<a name="l00393"></a>00393         <span class="keywordflow">if</span>(method_exists($this,$lfunc=<span class="stringliteral">&#39;layout_&#39;</span>.$name)){
<a name="l00394"></a>00394             <span class="keywordflow">if</span>($this-&gt;template-&gt;is_set($name)){
<a name="l00395"></a>00395                 $this-&gt;$lfunc();
<a name="l00396"></a>00396             }
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398         <span class="keywordflow">return</span> $this;
<a name="l00399"></a>00399     }
<a name="l00401"></a><a class="code" href="class_api_web.html#a182d30f6fcd3dd0ddcaaec36bbaf79db">00401</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#a182d30f6fcd3dd0ddcaaec36bbaf79db">layout_Content</a>(){
<a name="l00402"></a>00402         <span class="comment">// This function initializes content. Content is page-dependant</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         $page=str_replace(<span class="charliteral">&#39;/&#39;</span>,<span class="charliteral">&#39;_&#39;</span>,$this-&gt;page);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <span class="keywordflow">if</span>(method_exists($this,$pagefunc=<span class="stringliteral">&#39;page_&#39;</span>.$page)){
<a name="l00407"></a>00407             $p=$this-&gt;add(<span class="stringliteral">&#39;Page&#39;</span>,$this-&gt;page,<span class="stringliteral">&#39;Content&#39;</span>);
<a name="l00408"></a>00408             $this-&gt;$pagefunc($p);
<a name="l00409"></a>00409         }<span class="keywordflow">else</span>{
<a name="l00410"></a>00410             $this-&gt;api-&gt;locate(<span class="stringliteral">&#39;page&#39;</span>,str_replace(<span class="charliteral">&#39;_&#39;</span>,<span class="charliteral">&#39;/&#39;</span>,$this-&gt;page).<span class="stringliteral">&#39;.php&#39;</span>);
<a name="l00411"></a>00411             $this-&gt;add(<span class="stringliteral">&#39;page_&#39;</span>.$page,$page,<span class="stringliteral">&#39;Content&#39;</span>);
<a name="l00412"></a>00412             <span class="comment">//throw new BaseException(&quot;No such page: &quot;.$this-&gt;page);</span>
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414     }
<a name="l00416"></a><a class="code" href="class_api_web.html#add8c5a33f231d9979e5f8bbded576d9e">00416</a>     <span class="keyword">function</span> <a class="code" href="class_api_web.html#add8c5a33f231d9979e5f8bbded576d9e">defaultTemplate</a>(){
<a name="l00417"></a>00417         <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;shared&#39;</span>);
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419     <span class="comment">// }}} </span>
<a name="l00420"></a>00420 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>ApiWeb.php</b>      </li>

    <li class="footer">Generated on Thu Aug 23 2012 12:28:40 for Agile Toolkit by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
