<?$Content?>

<h1>Defining and using Relational Models</h1>

<p>The syntax of defining Relational Models is very similar to a regular models. There are however few differences:
<ul>
  <li>You should inherit from Model_Table</li>
  <li>You do not need to use setSource()</li>
  <li>You must specify $table property for each model, which is primary table</li>
</ul>
In addition, you have more methods to use and define fields.</p>
<h2>Defining and Traversing References between Models</h2>
<?Code?>
class Model_Author extends Model_Table {
  public $table='author';
  function init(){
    parent::init();
    $this->hasMany('Book');
    $this->hasOne('Country');

    // field definitions
  }
}
<?/?>
<p>A further use of the model can use function rel() to traverse towards other records. You must, however, load author record before traversing.</p>
<?Code?>
$author = $this->add('Model_Author');
$author->load($id);
$c_code = $author->ref('Country')->get('Code');

$this->add('Grid')->setModel($author->ref('Book'));
<?/?>
<p>When traversing relations defined as "hasOne" the record of related model is automatically loaded. That's why we were able to access field "Code" for country code. When traversing relations defined as hasMany() the returned model will not be preloaded with any records. It will however have a condition added to make sure any new records you are going to add with that model will belong to author identified by $id.</p>

<h2>Building model from multiple tables</h2>
<p>Let's assume that to store additional information about the author a new table "author_details" is created. This table contains "author_id". While in theory one author may have multiple records in author_details our logic dictates that it's one-on-one relationship. "author_id" is also defined as a primary field.</p>

<p>While we could have used references, it wouldn't let us join 2 tables seamlessly. To help out Model_Table has a join() method.</p>
<?Code?>
  // init of Model_Author
  $details = $this->join('author_details.author_id');

  $details->addField('bio');
  $details->addField('note')->as('details_note');
<?/?>


<h3>Default Fields</h3>
<p>Agile Toolkit uses some assumptions about the relations between fields. Table 'author' will have 'country_id' which is constructed by looking into 'Country' model's $table property and appending '_id'. That field is then loaded based on the "id" field of Author. If your id field is called differently, you can change id through a property "$id_field".</p>

<p>Sometimes you need to use a different field name when referencing. Then you need to use 2nd argument to "hasOne('Country','birth_country_id')".</p>

<?$Next?>
